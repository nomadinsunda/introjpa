# ğŸ”¥ Many-to-Many Bidirectional Association Mapping

JPA ì—°ê´€ ë§¤í•‘ ì¤‘ **ê°€ì¥ ë‚œë„ê°€ ë†’ê³ , ì‹¤ë¬´ì—ì„œ ê°€ì¥ ìì£¼ ì˜¤í•´Â·ë‚¨ìš©ë˜ëŠ”** ê²ƒì´ ë°”ë¡œ
`@ManyToMany` **ì–‘ë°©í–¥ ë§¤í•‘**ì…ë‹ˆë‹¤.

â€œì½”ë“œëŠ” 3ì¤„ë¡œ ëë‚˜ëŠ”ë°, ì™œ ìœ ì§€ë³´ìˆ˜ëŠ” ì§€ì˜¥ì´ ë˜ëŠ”ê°€?â€
â€” ì´ ì§ˆë¬¸ì— ëŒ€í•œ ëª¨ë“  ë‹µì„ ì§€ê¸ˆë¶€í„° ì •ë¦¬í•´ë“œë¦½ë‹ˆë‹¤.

---

# 1ï¸âƒ£ Many-to-Manyë€ ë¬´ì—‡ì¸ê°€? ğŸ¤

ë‘ ì—”í‹°í‹°ê°€ ì„œë¡œ **N:N Cardinality(ë‹¤ëŒ€ë‹¤)** ë¥¼ ê°€ì§€ëŠ” ê²½ìš°ì…ë‹ˆë‹¤.

ì˜ˆì‹œ:

| Member                         | Team                         |
| ------------------------------ | ---------------------------- |
| í•œ ëª…ì˜ MemberëŠ” ì—¬ëŸ¬ Teamì— ì†Œì†ë  ìˆ˜ ìˆìŒ | í•˜ë‚˜ì˜ Teamë„ ì—¬ëŸ¬ Memberë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŒ |

ê´€ê³„í˜• DBëŠ” **N:Nì„ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—**, ë°˜ë“œì‹œ **ì¡°ì¸ í…Œì´ë¸”(ì—°ê²° í…Œì´ë¸”)** ì´ í•„ìš”í•©ë‹ˆë‹¤.

---

# 2ï¸âƒ£ Many-to-Many ë§¤í•‘ êµ¬ì¡° ì´í•´í•˜ê¸° ğŸ§±

## ğŸ“Œ DB í…Œì´ë¸” êµ¬ì¡°

```
MEMBER (ID, NAME)
TEAM (ID, NAME)
MEMBER_TEAM (MEMBER_ID, TEAM_ID)  â† ì¡°ì¸ í…Œì´ë¸”
```

ì´ `MEMBER_TEAM` í…Œì´ë¸”ì´ **ìˆœìˆ˜ ì¡°ì¸ í…Œì´ë¸”(pure join table)** ì…ë‹ˆë‹¤.
ì¶”ê°€ ì†ì„± ì—†ì´ PK(FK1 + FK2)ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

---

# 3ï¸âƒ£ JPAì˜ Many-to-Many ì–‘ë°©í–¥ ëª¨ë¸ë§ ê¸°ë³¸ í˜•íƒœ ğŸ§©

ê°€ì¥ ê¸°ë³¸ì ì¸ í˜•íƒœëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

### ğŸ“Œ Member.java

```java
@Entity
public class Member {

    @Id @GeneratedValue
    private Long id;

    private String name;

    @ManyToMany
    @JoinTable(name = "member_team",
            joinColumns = @JoinColumn(name = "member_id"),
            inverseJoinColumns = @JoinColumn(name = "team_id"))
    private List<Team> teams = new ArrayList<>();

    // getters, setters
}
```

### ğŸ“Œ Team.java

```java
@Entity
public class Team {

    @Id @GeneratedValue
    private Long id;

    private String name;

    @ManyToMany(mappedBy = "teams")
    private List<Member> members = new ArrayList<>();

    // getters, setters
}
```

---

# 4ï¸âƒ£ ì™œ `mappedBy`ê°€ í•„ìš”í•œê°€? ğŸ¯

Many-to-Many ì–‘ë°©í–¥ì€ **í•­ìƒ ë‘ ê°œì˜ ì»¬ë ‰ì…˜ì´ ì„œë¡œë¥¼ ì°¸ì¡°**í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ JPA ì…ì¥ì—ì„œëŠ” â€œë‘˜ ì¤‘ ì–´ë–¤ ì—”í‹°í‹°ë¥¼ ê´€ê³„ì˜ ì£¼ì¸(Owner)ìœ¼ë¡œ ë³¼ ê²ƒì¸ê°€?â€ë¥¼ ì •í•´ì•¼ í•©ë‹ˆë‹¤.

## ğŸ”‘ ê·œì¹™

| ê·œì¹™                               | ì˜ë¯¸                        |
| -------------------------------- | ------------------------- |
| `mappedBy` ì—†ëŠ” ìª½ â†’ **ê´€ê³„ì˜ ì£¼ì¸**     | ì¡°ì¸ í…Œì´ë¸”ì— INSERT/UPDATEë¥¼ ìˆ˜í–‰ |
| `mappedBy` ìˆëŠ” ìª½ â†’ **ì½ê¸° ì „ìš©(ì—­ë°©í–¥)** | ë‹¨ìˆœíˆ ë§¤í•‘ëœ ê°’ ì½ê¸°ë§Œ ê°€ëŠ¥          |

ğŸ‘‰ `mappedBy = "teams"` â†’ Team ì—”í‹°í‹°ëŠ” Memberì˜ `teams` ì»¬ë ‰ì…˜ì— ì˜í•´ ë§¤í•‘ë¨ì„ ì˜ë¯¸í•¨.

---

# 5ï¸âƒ£ ì—°ê´€ê´€ê³„ ì €ì¥í•  ë•Œ í•­ìƒ ì–‘ìª½ì„ ëª¨ë‘ ì„¸íŒ…í•´ì•¼ í•œë‹¤ëŠ” ë¬¸ì œ âš ï¸

ì˜ˆ:

```java
member.getTeams().add(team);
team.getMembers().add(member);
```

ì–‘ë°©í–¥ ë§¤í•‘ì˜ **ê´€ê³„ í¸ì˜ ë©”ì„œë“œ(convenience method)** ë¥¼ ë§Œë“œëŠ” ì´ìœ ê°€ ë°”ë¡œ ì´ê²ƒì…ë‹ˆë‹¤.

### ğŸ“Œ Member

```java
public void addTeam(Team team) {
    this.teams.add(team);
    team.getMembers().add(this);
}
```

### ğŸ“Œ Team

```java
public void addMember(Member member) {
    this.members.add(member);
    member.getTeams().add(this);
}
```

---

# 6ï¸âƒ£ í•˜ì§€ë§Œ! ì‹¤ë¬´ì—ì„œëŠ” Many-to-Many ì–‘ë°©í–¥ì„ **ì ˆëŒ€ ì“°ì§€ ë§ë¼**ëŠ” ì´ìœ  ğŸš«ğŸ”¥

ë§ì€ ê¸°ì—…ì˜ JPA ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ì—ì„œëŠ” **ìˆœìˆ˜ Many-to-ManyëŠ” ê¸ˆì§€**ë¼ê³  ëª…ì‹œí•©ë‹ˆë‹¤.

## âŒ ë¬¸ì œ 1 â€” ì¡°ì¸ í…Œì´ë¸”ì— ì»¬ëŸ¼ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŒ

ì‹¤ë¬´ì—ì„œëŠ” ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì´ ê±°ì˜ í•„ìˆ˜ì…ë‹ˆë‹¤:

* `ì°¸ì—¬ì¼ì(joinedAt)`
* `ì‘ì„±ì(createdBy)`
* `ì—­í• (role)`
* `ìƒíƒœ(status)`

`@ManyToMany`ëŠ” ì´ëŸ° í™•ì¥ ë¶ˆê°€ â†’ **ì¦‰ì‹œ íê¸°í•´ì•¼ í•¨**

---

## âŒ ë¬¸ì œ 2 â€” ì¡°ì¸ í…Œì´ë¸”ì„ ì§ì ‘ ì œì–´í•  ìˆ˜ ì—†ìŒ

ì˜ˆë¥¼ ë“¤ì–´ ì¡°ì¸ í…Œì´ë¸”ì—
â€œTeamì€ ì¤‘ë³µ ì°¸ì—¬ ê¸ˆì§€â€ ê°™ì€ ì¡°ê±´ì„ ê±¸ê³  ì‹¶ì–´ë„ ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤.

---

## âŒ ë¬¸ì œ 3 â€” ì»¬ë ‰ì…˜ ì–‘ë°©í–¥ ì—…ë°ì´íŠ¸ë¡œ ì˜ë„ì¹˜ ì•Šì€ DELETE/INSERT ë°œìƒ

íŠ¹íˆ ë‹¤ìŒ ìƒí™©ì—ì„œ ë¬¸ì œê°€ ì»¤ì§‘ë‹ˆë‹¤:

```java
member.getTeams().clear();  
// ì¡°ì¸ í…Œì´ë¸”ì—ì„œ ëª¨ë“  ì—°ê²° DELETE ë°œìƒ
```

JPAëŠ” ì»¬ë ‰ì…˜ ë³€ê²½ì„ ê°ì§€í•˜ì—¬ **ì „ì²´ ì‚­ì œ í›„ ë‹¤ì‹œ insert** í•©ë‹ˆë‹¤.

ì´ëŠ” ì„±ëŠ¥ê³¼ ë°ì´í„° ë¬´ê²°ì„±ì—ì„œ í° ë¬¸ì œì…ë‹ˆë‹¤.

---

## âŒ ë¬¸ì œ 4 â€” JPAì˜ 1ì°¨ ìºì‹œì™€ ì»¬ë ‰ì…˜ ìŠ¤ëƒ…ìƒ· ë¹„êµë¡œ í¼í¬ë¨¼ìŠ¤ í­ë°œğŸ’¥

ì–‘ë°©í–¥ Many-to-ManyëŠ” **ì»¬ë ‰ì…˜ ìŠ¤ëƒ…ìƒ·ì´ í¬ê¸° ë•Œë¬¸ì—**
Dirty Checking ê³¼ì •ì—ì„œ ì—„ì²­ë‚œ ì—°ì‚°ì´ ë°œìƒí•©ë‹ˆë‹¤.

> íšŒì› ìˆ˜ 100ë§Œ, íŒ€ 1000ê°œ â†’ ì»¬ë ‰ì…˜ ë¹„êµ ì§€ì˜¥.

---

# 7ï¸âƒ£ ì‹¤ë¬´ì—ì„œëŠ” í•­ìƒ Many-to-Many â†’ **1:N + N:1 ì¡°ì¸ ì—”í‹°í‹°(Entity)ë¡œ ë¶„í•´**í•´ì•¼ í•œë‹¤ ğŸ’¡

ì¦‰ ë‹¤ìŒì²˜ëŸ¼ ì„¤ê³„í•´ì•¼ í•©ë‹ˆë‹¤.

```
MEMBER 1 â”€â”€â”€ N  MEMBER_TEAM  N â”€â”€â”€ 1 TEAM
```

## ğŸ“Œ Join Entity ë§Œë“¤ê¸° (ìš°ì•„í•œ ì‹¤ë¬´ ì„¤ê³„)

### MemberTeam.java (ì¡°ì¸ ì—”í‹°í‹°)

```java
@Entity
public class MemberTeam {

    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "member_id")
    private Member member;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "team_id")
    private Team team;

    private LocalDate joinedAt;

    private String role;

    // ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì„œë“œ
    public static MemberTeam create(Member m, Team t, String role) {
        MemberTeam mt = new MemberTeam();
        mt.setMember(m);
        mt.setTeam(t);
        mt.setRole(role);
        mt.setJoinedAt(LocalDate.now());
        return mt;
    }
}
```

## Member.java

```java
@Entity
public class Member {

    @Id @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "member", cascade = CascadeType.ALL)
    private List<MemberTeam> memberTeams = new ArrayList<>();
}
```

## Team.java

```java
@Entity
public class Team {

    @Id @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "team", cascade = CascadeType.ALL)
    private List<MemberTeam> memberTeams = new ArrayList<>();
}
```

ğŸ‘‰ ì´ë ‡ê²Œ í•˜ë©´
âœ” ì¡°ì¸ í…Œì´ë¸” ì œì–´ ê°€ëŠ¥
âœ” ì¶”ê°€ ì»¬ëŸ¼ ì‚½ì… ê°€ëŠ¥
âœ” ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ ëª…í™•
âœ” ì„±ëŠ¥ ì œì–´ ê°€ëŠ¥

---

# 8ï¸âƒ£ JPA ê´€ì ì—ì„œì˜ ë‚´ë¶€ ë™ì‘ ë©”ì»¤ë‹ˆì¦˜ ë¶„ì„ ğŸ§ 

### JPAëŠ” Many-to-Manyë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ê°€?

1. ì¡°ì¸ í…Œì´ë¸”ì€ ì—”í‹°í‹°ê°€ ì•„ë‹˜
2. JPAëŠ” ë‹¨ìˆœí•˜ê²Œ ì—°ê²° ê´€ê³„ë§Œ ê´€ë¦¬
3. ì»¬ë ‰ì…˜ ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ì¡°ì¸ í…Œì´ë¸”ì—
   `INSERT`, `DELETE`ë¥¼ ìë™ ìƒì„±
4. ì–‘ìª½ ì»¬ë ‰ì…˜ ëª¨ë‘ ìœ ì§€í•´ì•¼ ë™ê¸°í™”ë¨
5. Dirty Checking ì‹œ ê° ì»¬ë ‰ì…˜ì˜ ìŠ¤ëƒ…ìƒ·ì„ ë¹„êµí•¨
6. Flush ì‹œ ì¡°ì¸ í…Œì´ë¸”ì˜ ë³€ê²½ì„ ë°˜ì˜í•¨

---

# 9ï¸âƒ£ ì‹¤ë¬´ ê¸°ì¤€ Best Practice ğŸ†

| í•­ëª©                           | ê¶Œì¥          |
| ---------------------------- | ----------- |
| ìˆœìˆ˜ Many-to-Many              | âŒ ê¸ˆì§€        |
| ì¡°ì¸ ì—”í‹°í‹° í¬í•¨ ì„¤ê³„                 | âœ… í•„ìˆ˜        |
| ì–‘ë°©í–¥ Many-to-Many             | âŒ ê±°ì˜ ì‚¬ìš© ê¸ˆì§€  |
| ì¼ë°©í–¥ Many-to-Many             | âš ï¸ ë§¤ìš° ì œí•œì ìœ¼ë¡œ |
| Many-to-Many + Cascade       | âŒ ìœ„í—˜        |
| Many-to-Many + orphanRemoval | âŒ í—ˆìš©ë˜ì§€ ì•ŠìŒ   |

---

# ğŸ”Ÿ ì™„ì „í•œ ì‹¤ì „ ì˜ˆì œ: Member â€“ Team â€“ MemberTeam ğŸ¯

ì•„ë˜ëŠ” ì‹¤ë¬´ì—ì„œ ì“°ëŠ” ì™„ì„±ëœ í˜•íƒœì…ë‹ˆë‹¤.

---

## ğŸ“Œ ì˜ˆì œ: Memberê°€ Teamì— ì—­í• (Role) í¬í•¨í•´ì„œ ì°¸ì—¬í•˜ëŠ” ë„ë©”ì¸

### MemberService

```java
@Transactional
public void joinTeam(Long memberId, Long teamId, String role) {

    Member member = memberRepository.findById(memberId).orElseThrow();
    Team team = teamRepository.findById(teamId).orElseThrow();

    MemberTeam mt = MemberTeam.create(member, team, role);

    member.getMemberTeams().add(mt);
    team.getMemberTeams().add(mt);

    memberTeamRepository.save(mt);
}
```

---

# ğŸ§­ ê²°ë¡ : Many-to-Many ì–‘ë°©í–¥ ë§¤í•‘ì€ â€œí¸ë¦¬í•´ ë³´ì´ì§€ë§Œ ì‹¤ì „ì—ì„œëŠ” í•¨ì •â€ì´ë‹¤ ğŸ’€

ì •ë¦¬:

| í•­ëª©        | ìˆœìˆ˜ Many-to-Many | ì¡°ì¸ ì—”í‹°í‹° |
| --------- | --------------- | ------ |
| ì¡°ì¸ í…Œì´ë¸” ì œì–´ | âŒ               | â­•      |
| ë¶€ê°€ ì •ë³´ ì¶”ê°€  | âŒ               | â­•      |
| ì„±ëŠ¥ ì œì–´     | âŒ               | â­•      |
| ì‹¤ë¬´ ì í•©ì„±    | âŒ               | â­•      |

ğŸ“Œ **ì‹¤ë¬´ ê°œë°œì, ì•„í‚¤í…íŠ¸ë¼ë©´ Many-to-Manyë¥¼ ì¦‰ì‹œ 1:N + N:1ë¡œ ë¶„í•´í•´ì•¼ í•©ë‹ˆë‹¤.**
ğŸ“Œ JPAë¡œ MSA ê°œë°œ ì‹œì—” â€œì¡°ì¸ ì—”í‹°í‹° ê¸°ë°˜ ì„¤ê³„â€ê°€ ë¬´ì¡°ê±´ í•„ìˆ˜ì…ë‹ˆë‹¤.


