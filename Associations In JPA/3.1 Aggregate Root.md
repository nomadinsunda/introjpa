# ğŸŸ¦ â€œAggregate Root, Composition, Aggregation, ê·¸ë¦¬ê³  JPA Cascadeì˜ ì •í™•í•œ ê´€ê³„

ë„ë©”ì¸ ëª¨ë¸ë§(Domain Modeling)ê³¼ JPAë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ë©´
ê°ì²´ì˜ ìƒëª…ì£¼ê¸°(Lifecycle), ì¼ê´€ì„± ê·œì¹™(Invariant), ì—°ê´€ê´€ê³„ ì„¤ê³„, Cascade ì „ëµì´ ì„œë¡œ ê¼¬ì—¬
í˜¼ë€ì´ ë°œìƒí•˜ê¸° ì‰½ìŠµë‹ˆë‹¤.

ì´ë¥¼ ëª…í™•í•˜ê²Œ ì´í•´í•˜ë ¤ë©´,
DDDì˜ í•µì‹¬ ê°œë…ì¸ **Aggregate / Aggregate Root** ë¥¼ ì •í™•íˆ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤.
ì´ ê¸€ì—ì„œëŠ” ë‹¨ìˆœ ê°œë… ì„¤ëª…ì´ ì•„ë‹Œ,
**ì‹¤ì œ Order / OrderItem / Item ë„ë©”ì¸ì„ ê¸°ì¤€ìœ¼ë¡œ í•œ ì™„ì „í•œ í†µí•© ëª¨ë¸**ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.

---

# ğŸŸ© 1. Aggregateë€ ë¬´ì—‡ì¸ê°€? â€” â€œì¼ê´€ì„± ê²½ê³„(Consistency Boundary)â€

Aggregate(ì• ê·¸ë¦¬ê²Œì´íŠ¸)ëŠ”
ë„ë©”ì¸ ëª¨ë¸ì„ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•œ **ë…¼ë¦¬ì  ê²½ê³„(Boundary)** ì…ë‹ˆë‹¤.

í•˜ë‚˜ì˜ Aggregate ì•ˆì—ëŠ” ì—¬ëŸ¬ ì—”í‹°í‹°ê°€ ì¡´ì¬í•  ìˆ˜ ìˆì§€ë§Œ,
ê·¸ ì—”í‹°í‹°ë“¤ì€ ë°˜ë“œì‹œ ì•„ë˜ ê¸°ì¤€ì„ ë§Œì¡±í•´ì•¼ í•©ë‹ˆë‹¤.

### âœ” (1) ë…¼ë¦¬ì ìœ¼ë¡œ í•˜ë‚˜ì˜ â€œì¼ê´€ì„± ê·¸ë£¹(Consistency Group)â€

ì˜ˆë¥¼ ë“¤ì–´:

* Order + OrderItem
* Board + AttachedFile
* Invoice + InvoiceLine

ì´ë“¤ì€ ê°œë³„ì ìœ¼ë¡œ ì¡´ì¬í•˜ë”ë¼ë„
ë¹„ì¦ˆë‹ˆìŠ¤ ê´€ì ì—ì„œëŠ” **í•­ìƒ í•¨ê»˜ ë³€í™”í•´ì•¼ ì¼ê´€ì„±ì´ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.**

### âœ” (2) í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì—¬ì•¼ í•œë‹¤

Aggregate ë‚´ë¶€ì˜ í•µì‹¬ ê·œì¹™(Invariant)ì€
**í•­ìƒ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ìœ ì§€** ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆ:

* ì£¼ë¬¸ ì´ì•¡ = ì£¼ë¬¸ìƒí’ˆ(OrderItem)ë“¤ì˜ í•©
* ì£¼ë¬¸ ì·¨ì†Œ ì‹œ ì¬ê³  ë³µêµ¬
* ê²Œì‹œê¸€ ì‚­ì œ â†’ ì²¨ë¶€íŒŒì¼ ì‚­ì œ

AggregateëŠ” ë°”ë¡œ ì´ëŸ¬í•œ **ë„ë©”ì¸ ê·œì¹™ì„ ì§€í‚¤ëŠ” ë‹¨ìœ„**ì…ë‹ˆë‹¤.

---

# ğŸŸ¦ 2. Aggregate Rootë€ ë¬´ì—‡ì¸ê°€?

Aggregate ë‚´ë¶€ì—ëŠ” ì—¬ëŸ¬ ì—”í‹°í‹°ê°€ ìˆì„ ìˆ˜ ìˆì§€ë§Œ
**ì™¸ë¶€ì—ì„œ Aggregate ë‚´ë¶€ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ìœ ì¼í•œ ì°½êµ¬**,
ê·¸ë¦¬ê³  **ì „ì²´ ê·œì¹™ì„ ëŒ€í‘œí•˜ëŠ” ì—”í‹°í‹°**,
ì´ê²ƒì´ **Aggregate Root** ì…ë‹ˆë‹¤.

> **Aggregate RootëŠ” ë‚´ë¶€ ì—”í‹°í‹°ë¥¼ ë³´í˜¸í•˜ê³ ,
> ë„ë©”ì¸ ê·œì¹™ì„ ìœ ì§€í•˜ë©°,
> ì „ì²´ ì—”í‹°í‹°ë“¤ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ëŠ” ì¤‘ì‹¬ ì—”í‹°í‹°ì…ë‹ˆë‹¤.**

ì¦‰, ë‹¤ìŒ ëª¨ë“  í–‰ìœ„ëŠ” **Rootë¥¼ í†µí•´ì„œë§Œ** ì¼ì–´ë‚˜ì•¼ í•©ë‹ˆë‹¤.

* ìƒì„±
* ìˆ˜ì •
* ì‚­ì œ
* ì¡°íšŒ

ë‚´ë¶€ ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë§Œì§€ë©´
Aggregateì˜ ì¼ê´€ì„±ì´ ê¹¨ì§€ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

---

# ğŸŸ¥ 3. ì‹¤ì „ ëª¨ë¸: Order / OrderItem / Item êµ¬ì¡° í•´ë¶€

ì´ì œ ì ìš©í•´ ë´…ë‹ˆë‹¤.
ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ì‹¤ì œ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

---

## ğŸŸ§ 3-1. Item â€” ë…ë¦½ì ì¸ Aggregate Root (ì¹´íƒˆë¡œê·¸ ë„ë©”ì¸)

```java
@Entity
public class Item {

    @Id @GeneratedValue
    private Long id;

    private String name;
    private int price;
    private int stockQuantity;

    protected Item() {}

    public Item(String name, int price, int stockQuantity) {
        this.name = name;
        this.price = price;
        this.stockQuantity = stockQuantity;
    }

    public void removeStock(int qty) {
        if (this.stockQuantity < qty) {
            throw new IllegalArgumentException("ì¬ê³  ë¶€ì¡±");
        }
        this.stockQuantity -= qty;
    }

    public void addStock(int qty) {
        this.stockQuantity += qty;
    }

    public String getName() {
        return name;
    }
}
```

### **Itemì€ Orderì™€ ë¬´ê´€í•˜ê²Œ ì¡´ì¬í•  ìˆ˜ ìˆëŠ” ë…ë¦½ Aggregate Rootì…ë‹ˆë‹¤.**

* ìƒí’ˆ ë“±ë¡/ìˆ˜ì •/ì‚­ì œëŠ” ì£¼ë¬¸ê³¼ ê´€ê³„ ì—†ìŒ
* ì—¬ëŸ¬ OrderItemì´ í•˜ë‚˜ì˜ Itemì„ ê³µìœ í•  ìˆ˜ ìˆìŒ
* ìƒëª…ì£¼ê¸° ì „íŒŒ(Cascade)ë¥¼ ë°›ì•„ì„œëŠ” ì•ˆ ë¨ â†’ **Aggregation ê´€ê³„**

---

## ğŸŸ§ 3-2. OrderItem â€” ë‘ Aggregateë¥¼ ì‡ëŠ” êµì°¨ ì—”í‹°í‹° (Composition + Aggregation)

```java
@Entity
public class OrderItem {

    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)   // ğŸ”¥ ìˆœìˆ˜ Aggregation
    @JoinColumn(name = "item_id", nullable = false)
    private Item item;                   // ğŸ”¥ ë…ë¦½ ì—”í‹°í‹°(ë³„ë„ Aggregate Root)

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id", nullable = false)
    private Order order;                 // Strong Composition (Order ìª½)

    private int orderPrice;
    private int quantity;

    protected OrderItem() {}

    public OrderItem(Item item, Order order, int price, int qty) {
        this.item = item;
        this.order = order;
        this.orderPrice = price;
        this.quantity = qty;
    }

    public int getTotalPrice() {
        return orderPrice * quantity;
    }

    public Item getItem() {
        return item;
    }
}
```

ì—¬ê¸°ì„œ ê´€ê³„ëŠ” ëª…í™•íˆ ë‘ ì¢…ë¥˜ì…ë‹ˆë‹¤.

### âœ” OrderItem â†’ Order (Strong Composition)

* Orderì˜ ë‚´ë¶€ êµ¬ì„±ìš”ì†Œ
* Order ì—†ì´ëŠ” ì¡´ì¬ ë¶ˆê°€ëŠ¥
* Orderê°€ ìƒëª…ì£¼ê¸° í†µì œ
* Cascade + orphanRemoval ëŒ€ìƒ

### âœ” OrderItem â†’ Item (ìˆœìˆ˜ Aggregation)

* Itemì€ ë³„ë„ Aggregate Root
* OrderItemì´ ì‚¬ë¼ì ¸ë„ Itemì€ ê·¸ëŒ€ë¡œ
* ìƒëª…ì£¼ê¸° ì „íŒŒ ì—†ìŒ
* ë‹¨ìˆœ ì°¸ì¡° ê´€ê³„
* Cascade ì ˆëŒ€ ê¸ˆì§€

ì´ ì°¨ì´ê°€ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤.

---

## ğŸŸ§ 3-3. Order â€” Order Aggregateì˜ Root

```java
@Entity
public class Order {

    @Id @GeneratedValue
    private Long id;

    private LocalDateTime orderDate;

    @Enumerated(EnumType.STRING)
    private OrderStatus status;

    @OneToMany(mappedBy = "order",
               cascade = CascadeType.ALL,
               orphanRemoval = true)
    private List<OrderItem> orderItems = new ArrayList<>();

    protected Order() {}

    public Order(LocalDateTime orderDate) {
        this.orderDate = orderDate;
        this.status = OrderStatus.ORDERED;
    }

    public void addOrderItem(OrderItem orderItem) {
        orderItems.add(orderItem);
    }

    public void removeOrderItem(OrderItem orderItem) {
        orderItems.remove(orderItem);  // orphanRemoval = true â†’ ìë™ ì‚­ì œ
    }

    public int getTotalPrice() {
        return orderItems.stream()
                         .mapToInt(OrderItem::getTotalPrice)
                         .sum();
    }

    public void cancel() {
        if (this.status == OrderStatus.SHIPPED) {
            throw new IllegalStateException("ì´ë¯¸ ë°°ì†¡ëœ ì£¼ë¬¸ì€ ì·¨ì†Œ ë¶ˆê°€");
        }
        this.status = OrderStatus.CANCELED;
    }
}
```

### Orderì˜ ì±…ì„ = Aggregate Rootì˜ ì±…ì„

* OrderItem ì¶”ê°€/ì‚­ì œ
* ìƒíƒœ ë³€ê²½
* ì·¨ì†Œ ì •ì±…
* ì´ê¸ˆì•¡ ê³„ì‚°
* ë‚´ë¶€ ì—”í‹°í‹° ìƒëª…ì£¼ê¸° ê´€ë¦¬
* ë„ë©”ì¸ ê·œì¹™(Invariant) ë³´ì¥

Aggregate RootëŠ” ë‹¨ìˆœ ì—”í‹°í‹°ê°€ ì•„ë‹ˆë¼
**ì „ì²´ ë„ë©”ì¸ì˜ ê·œì¹™ ê´€ë¦¬ì**ì…ë‹ˆë‹¤.

---

# ğŸŸ© 4. Aggregate ì „ì²´ êµ¬ì¡° ìš”ì•½

```
[Aggregate A] Order (Root)
    â””â”€ OrderItem (Composition â€” ë‚´ë¶€ ì—”í‹°í‹°)

[Aggregate B] Item (Root)
```

### í•µì‹¬ ìš”ì•½

| ê´€ê³„                | ìœ í˜•                 | Cascade | ìƒëª…ì£¼ê¸°      | ì˜ë¯¸      |
| ----------------- | ------------------ | ------- | --------- | ------- |
| Order â†’ OrderItem | Strong Composition | YES     | Orderê°€ ê´€ë¦¬ | ë‚´ë¶€ êµ¬ì„±ìš”ì†Œ |
| OrderItem â†’ Item  | ìˆœìˆ˜ Aggregation     | NO      | ë…ë¦½ ìƒì¡´     | ë‹¨ìˆœ ì°¸ì¡°   |

---

# ğŸŸ¥ 5. Aggregate Root ì„¤ê³„ë¥¼ ì˜ëª»í•˜ë©´ ë²Œì–´ì§€ëŠ” ì‹¤ë¬´ ì‚¬ê³ ë“¤

### âŒ Aggregation(Item)ì— Cascadeë¥¼ ê±¸ë©´?

```java
@ManyToOne(cascade = CascadeType.ALL)
private Item item;
```

â†’ ì£¼ë¬¸ ì·¨ì†Œ ì‹œ Itemê¹Œì§€ ì‚­ì œ
â†’ ë‹¤ë¥¸ ì£¼ë¬¸ë“¤ì˜ Itemë„ ëª¨ë‘ ì‚­ì œ
â†’ ìƒí’ˆ ì¹´íƒˆë¡œê·¸ ë¶•ê´´
â†’ ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œ ê°€ì¥ ë§ì´ ë°œìƒí•˜ëŠ” ëŒ€í˜• ì‚¬ê³ 

---

### âŒ OrderItemRepository ë§Œë“¤ê¸°

ë‚´ë¶€ ì—”í‹°í‹°ë¥¼ Root ë°–ì—ì„œ CRUD â†’
ë„ë©”ì¸ ì¼ê´€ì„± ë¶•ê´´ â†’ ì´ì•¡/ì¬ê³ /ìƒíƒœ ëª¨ë‘ ì´ìƒ

---

### âŒ Rootë¥¼ ìš°íšŒí•œ ë³€ê²½

OrderItemì„ ë‹¨ë… ìˆ˜ì •í•˜ë©´ Orderì˜ ê·œì¹™ê³¼ ë¶ˆì¼ì¹˜ ë°œìƒ

---

# ğŸŸ¦ 6. Aggregate Root í•µì‹¬ ì •ë¦¬ (í•œ ì¤„ì”©)

* Aggregate = **ì¼ê´€ì„±ì´ í•„ìš”í•œ ëª¨ë¸ì˜ ê²½ê³„**
* Aggregate Root = **ê²½ê³„ ë‚´ë¶€ì˜ ìœ ì¼í•œ ì§„ì…ì **
* ë‚´ë¶€ ì—”í‹°í‹° = Rootê°€ ìƒëª…ì£¼ê¸° ì±…ì„ (Composition)
* ì™¸ë¶€ Aggregateì™€ì˜ ê´€ê³„ = ë‹¨ìˆœ ì°¸ì¡° (Aggregation)
* Cascade = Rootê°€ ë‚´ë¶€ ì—”í‹°í‹° ìƒëª…ì£¼ê¸°ë¥¼ ë‹´ë‹¹í•  ë•Œë§Œ ì‚¬ìš©
* Repository = Rootì—ê²Œë§Œ ë¶€ì—¬
* ëª¨ë“  ë„ë©”ì¸ ì¡°ì‘ì€ Rootë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰í•´ì•¼ ë¶ˆë³€ ì¡°ê±´ ìœ ì§€ ê°€ëŠ¥

---

# ğŸ¯ ìµœì¢… ê²°ë¡ 

Order / OrderItem / Item êµ¬ì¡°ëŠ”
Aggregate / Root / Composition / Aggregation / Cascade ê°œë…ì„
ê°€ì¥ êµê³¼ì„œì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” ì‹¤ì „ ëª¨ë¸ì…ë‹ˆë‹¤.

* **Order = Aggregate Root**
* **OrderItem = Order Aggregate ë‚´ë¶€ ì—”í‹°í‹° â†’ Composition**
* **Item = ë³„ë„ Aggregate Root â†’ Aggregation**
* **CascadeëŠ” Compositionì—ì„œë§Œ ì‚¬ìš©**
* **Aggregationì—ëŠ” ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€**

ì´ ì›ì¹™ì„ ì´í•´í•˜ë©´
JPA ì—°ê´€ê´€ê³„, Cascade ì „ëµ, ë„ë©”ì¸ ëª¨ë¸ë§ ì¶©ëŒ ë¬¸ì œë¥¼
ì™„ì „íˆ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

