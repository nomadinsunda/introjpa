

# ğŸŸ¨ **ğŸ“Œ ìˆœìˆ˜ Aggregation(Pure Aggregation)

# ğŸ”· **ìƒ˜í”Œ ì½”ë“œ**

## ğŸŸ¦ `Item` â€” ë…ë¦½ Aggregate Root (Aggregationì˜ ëŒ€ìƒ)

```java
@Entity
public class Item {

    @Id @GeneratedValue
    private Long id;

    private String name;
    private int price;
    private int stockQuantity;

    protected Item() {}

    public Item(String name, int price, int stockQuantity) {
        this.name = name;
        this.price = price;
        this.stockQuantity = stockQuantity;
    }

    public void removeStock(int qty) {
        if (this.stockQuantity < qty) {
            throw new IllegalArgumentException("ì¬ê³  ë¶€ì¡±");
        }
        this.stockQuantity -= qty;
    }

    public void addStock(int qty) {
        this.stockQuantity += qty;
    }

    public String getName() {
        return name;
    }
}
```

---

## ğŸŸ¦ `OrderItem` â€” Itemì„ â€œì°¸ì¡°â€ë§Œ í•˜ëŠ” Aggregation ê´€ê³„

```java
@Entity
public class OrderItem {

    @Id @GeneratedValue
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)   // ğŸ”¥ ìˆœìˆ˜ Aggregation
    @JoinColumn(name = "item_id", nullable = false)
    private Item item;                   // ğŸ”¥ ë…ë¦½ ì—”í‹°í‹° ì°¸ì¡°

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "order_id", nullable = false)
    private Order order;                 // Strong Composition (OrderItem â†’ Order)

    private int orderPrice;
    private int quantity;

    protected OrderItem() {}

    public OrderItem(Item item, Order order, int price, int qty) {
        this.item = item;
        this.order = order;
        this.orderPrice = price;
        this.quantity = qty;
    }

    public int getTotalPrice() {
        return orderPrice * quantity;
    }

    public Item getItem() {
        return item;
    }
}
```

---

# ğŸŸ¨ **1. ìˆœìˆ˜ Aggregationì´ë€ ë¬´ì—‡ì¸ê°€? (ìƒ˜í”Œ ì½”ë“œ ê¸°ë°˜ ì •ì˜)**

> **OrderItemì´ Itemì„ ì°¸ì¡°í•˜ì§€ë§Œ,
> Itemì€ OrderItemê³¼ ì „í˜€ ìƒëª…ì£¼ê¸°ë¥¼ ê³µìœ í•˜ì§€ ì•ŠëŠ” ê´€ê³„.**

ì¦‰:

âœ” Itemì€ OrderItem ì—†ì–´ë„ ì¡´ì¬í•¨
âœ” OrderItemì´ ì‚­ì œë¼ë„ Itemì€ ì‚­ì œë˜ë©´ ì•ˆ ë¨
âœ” í•˜ë‚˜ì˜ Itemì„ ì—¬ëŸ¬ OrderItemì´ ê³µìœ  ê°€ëŠ¥
âœ” OrderItemì´ Itemì„ â€œì†Œìœ (Composition)â€í•˜ëŠ” ê²ƒì´ ì•„ë‹˜
âœ” OrderItemì€ Itemì˜ ìƒëª…/ì£½ìŒì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒ
âœ” Itemì€ ë…ë¦½ Aggregate Root

ì´ ëª¨ë“  íŠ¹ì„±ì´ ìƒ˜í”Œ ì½”ë“œì— ì •í™•íˆ ë“œëŸ¬ë‚œë‹¤:

```java
@ManyToOne(fetch = LAZY)  // Cascade ì—†ìŒ â†’ ìƒëª…ì£¼ê¸° ë…ë¦½
private Item item;
```

---

# ğŸŸ¨ **2. ì™œ OrderItem â†’ Item ê´€ê³„ëŠ” ìˆœìˆ˜ Aggregationì¸ê°€?**

Itemì€ ì‡¼í•‘ëª°ì—ì„œ â€œìƒí’ˆâ€ì´ë©°,
ì£¼ë¬¸(OrderItem)ì´ ì—†ì–´ë„
ìƒí’ˆ(Item)ì€ ì´ë¯¸ ì¡´ì¬í•˜ê³ , ê³„ì† ì¡´ì¬í•´ì•¼ í•œë‹¤.

### âœ” Itemì€ ë…ë¦½ ì—”í‹°í‹°ë‹¤

```java
Item item = new Item("ë…¸íŠ¸ë¶", 1500000, 10);
em.persist(item);
```

OrderItem ì—†ì´ ê·¸ëƒ¥ ì €ì¥ë¨.
**ì´ê²Œ Aggregationì˜ ì²« ë²ˆì§¸ ì¡°ê±´.**

---

### âœ” OrderItemì€ Itemì˜ ìƒëª…ì£¼ê¸°ë¥¼ ì¡°ì‘í•  ìˆ˜ ì—†ë‹¤

OrderItemì´ ì‚­ì œë˜ì–´ë„ Itemì€ ê·¸ëŒ€ë¡œ ë‚¨ì•„ì•¼ í•œë‹¤.

ë”°ë¼ì„œ CascadeType.REMOVE / ALL ì€ ì ˆëŒ€ ê¸ˆì§€.

---

### âœ” Itemì€ ì—¬ëŸ¬ OrderItemì´ ì°¸ì¡° ê°€ëŠ¥(Shared Resource)

```
OrderItem #1 â†’ Item A  
OrderItem #2 â†’ Item A  
OrderItem #3 â†’ Item A
```

Item í•˜ë‚˜ê°€ ì—¬ëŸ¬ OrderItemì—ì„œ ì“°ì¸ë‹¤.
**ì´ê²ƒì´ Aggregationì˜ ê²°ì •ì  ì¦ê±°.**

---

# ğŸŸ¨ **3. JPA ë§¤í•‘ ê·œì¹™ (ìƒ˜í”Œ ì½”ë“œ ê¸°ë°˜)**

## âœ” 1) Cascade ê¸ˆì§€

```java
@ManyToOne(fetch = LAZY)
private Item item;
```

ì—¬ê¸°ì„œ `cascade = CascadeType.ALL` ì„ ë¶™ì´ë©´?

ğŸš¨ ì£¼ë¬¸ ì·¨ì†Œ(OrderItem ì‚­ì œ) â†’ Item ì‚­ì œë¨ â†’ ëŒ€ì°¸ì‚¬
(ì‹¤ë¬´ì—ì„œ ì‹¤ì œë¡œ ìì£¼ ì¼ì–´ë‚˜ëŠ” ì‚¬ê³ )

**Aggregationì€ ìƒëª…ì£¼ê¸° ë¶„ë¦¬ë¥¼ í•´ì•¼ í•˜ëŠ” ê´€ê³„ì´ë¯€ë¡œ Cascade ê¸ˆì§€**

---

## âœ” 2) orphanRemoval ê¸ˆì§€

orphanRemoval = true ëŠ” â€œë¶€ëª¨ê°€ ìì‹ì„ ì‚­ì œí•˜ëŠ” êµ¬ì¡°â€
â†’ Composition ê°œë…
â†’ Aggregationì´ ì•„ë‹˜.

---

## âœ” 3) FKëŠ” OrderItemì— ì¡´ì¬í•˜ì§€ë§Œ ì˜ë¯¸ëŠ” â€œì°¸ì¡°â€ì¼ ë¿

ë§ˆì¹˜ ì•„ë˜ì™€ ê°™ì€ DB êµ¬ì¡°:

```
order_item
 â”œâ”€ id
 â”œâ”€ order_id  FK (Order)
 â””â”€ item_id   FK (Item)
```

item_idê°€ FKë¼ í•´ì„œ
OrderItemì´ Itemì„ ì†Œìœ í•œë‹¤ëŠ” ì˜ë¯¸ê°€ ì•„ë‹ˆë‹¤.
ê·¸ì € ì°¸ì¡°ì¼ ë¿ì´ë‹¤.

---

## âœ” 4) ì €ì¥/ì‚­ì œëŠ” í•­ìƒ ë³„ë„ë¡œ ìˆ˜í–‰

```java
em.persist(item);        // Item ë…ë¦½ ì €ì¥
em.persist(orderItem);   // OrderItem ë³„ë„ ì €ì¥
```

OrderItem.persist() â†’ Item.persist() ì „íŒŒ ì—†ìŒ
OrderItem.remove() â†’ Item.remove() ì „íŒŒ ì—†ìŒ

ğŸ”¥ ì´ê²ƒì´ Aggregation.

---

# ğŸŸ¨ **4. Hibernate ë‚´ë¶€ ë™ì‘ (ìƒ˜í”Œ ì½”ë“œ ê¸°ë°˜ ì „ë¬¸ ì„¤ëª…)**

### âœ” OrderItem.persist()

* Itemì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì „í˜€ ë³€í™” ì—†ìŒ
* ActionQueueì— Item ê´€ë ¨ Actionì´ ìƒì„±ë˜ì§€ ì•ŠìŒ

### âœ” OrderItem.remove()

* Item ê´€ë ¨ Delete Action ì—†ìŒ
* Itemì€ ì ˆëŒ€ ì˜í–¥ì„ ë°›ì§€ ì•ŠìŒ

ì¦‰,

> **OrderItem â†’ Item ê´€ê³„ëŠ” Hibernate ActionQueueì—
> Item ê´€ë ¨ Action(INSERT/DELETE)ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.**

â†’ ìƒëª…ì£¼ê¸° ì™„ì „ ë¶„ë¦¬ = Aggregation

---

# ğŸŸ¨ **5. DDD Aggregate ê´€ì  (ìƒ˜í”Œ ì½”ë“œ ê¸°ë°˜)**

### êµ¬ì¡°ëŠ” ì´ë ‡ê²Œ ëœë‹¤:

```
Order (Aggregate Root)
 â””â”€ OrderItem (Order ë‚´ë¶€ ì—”í‹°í‹° â€” Composition)

Item (ë…ë¦½ Aggregate Root)
```

### ê´€ê³„ í•´ì„

* OrderItemì€ Order ë‚´ë¶€ ì—”í‹°í‹° â†’ Strong Composition
* OrderItem â†’ Item ì€ ë‹¤ë¥¸ Aggregate Root ì°¸ì¡° â†’ Aggregation

ì¦‰,
ìƒ˜í”Œ ì½”ë“œ í•˜ë‚˜ë¡œ **Composition + Aggregation**ì´ ëª¨ë‘ í‘œí˜„ë˜ê³  ìˆë‹¤.

---

# ğŸŸ¨ **6. ì‹¤ë¬´ì—ì„œ ë°œìƒí•˜ëŠ” ë¬¸ì œ (ìƒ˜í”Œ ì½”ë“œ ê¸°ë°˜)**

## âŒ CascadeType.ALL ì‹¤ìˆ˜

```java
@ManyToOne(cascade = CascadeType.ALL)
```

â†’ ì£¼ë¬¸ ì·¨ì†Œ â†’ OrderItem ì‚­ì œ â†’ Item ì‚­ì œ
â†’ ë‹¤ë¥¸ ì£¼ë¬¸ì˜ Itemë„ ì‚­ì œ â†’ ì¥ì•  ë°œìƒ

(ì‹¤ë¬´ì—ì„œ ìì£¼ ì‹¤ì œë¡œ ì¼ì–´ë‚¨)

---

## âŒ OneToMany ë‹¨ë°©í–¥ìœ¼ë¡œ ì˜ëª» ì„¤ê³„

Aggregationì€ ManyToOne ë‹¨ë°©í–¥ì´ ì •ì„
(ìƒ˜í”Œ ì½”ë“œê°€ ì •í™•í•œ ì •ë‹µ)

---

## âŒ Lazy ë¡œë”©ì— ë”°ë¥¸ N+1 ë¬¸ì œ

í•´ê²°: fetch join, batch-size

---

# ğŸŸ© **7. ìµœì¢… ìš”ì•½ â€” ìƒ˜í”Œ ì½”ë“œ ê¸°ë°˜ Aggregation ì™„ì „ ì •ì˜**

### âœ” OrderItem â†’ Item ì€ ìˆœìˆ˜ Aggregationì´ë‹¤

* ë‘ ì—”í‹°í‹°ëŠ” ìƒëª…ì£¼ê¸° ë…ë¦½
* Cascade ì—†ìŒ
* orphanRemoval ì—†ìŒ
* Itemì€ ë…ë¦½ Aggregate Root
* ì—¬ëŸ¬ OrderItemì—ì„œ ê³µìœ  ê°€ëŠ¥
* ì €ì¥/ì‚­ì œ ëª¨ë‘ ë¶„ë¦¬
* ë‹¨ìˆœ ì°¸ì¡° ê´€ê³„

### âœ” ì½”ë“œë¡œ ì¦ëª…ë¨

```java
@ManyToOne(fetch = LAZY)  
@JoinColumn(name = "item_id")
private Item item;
```

### âœ” OrderItem â†’ Order ì€ Strong Compositionì´ë‹¤

(ìƒëª…ì£¼ê¸° ê³µìœ )
ë”°ë¼ì„œ ë‘ ê´€ê³„ëŠ” ì™„ì „íˆ ë‹¤ë¥´ë‹¤.


