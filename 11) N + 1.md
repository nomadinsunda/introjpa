

# ğŸ§© ê²Œì‹œíŒ ê¸€ê³¼ ëŒ“ê¸€ë¡œ ì´í•´í•˜ëŠ” N + 1 ë¬¸ì œ

ê²Œì‹œíŒì€ ë‹¨ìˆœí•´ ë³´ì´ì§€ë§Œ, ORM(JPA/Hibernate)ì„ ì“°ëŠ” ìˆœê°„
**ì„±ëŠ¥ ì§€ë¢°ê°€ ê°€ì¥ ë§ì´ ë¬»íˆëŠ” ë„ë©”ì¸** ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.

íŠ¹íˆ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì€ *ê±°ì˜ 100% í™•ë¥ ë¡œ* N + 1 ë¬¸ì œê°€ ìˆ¨ì–´ ìˆìŠµë‹ˆë‹¤.

* ê²Œì‹œê¸€ ëª©ë¡ + ê° ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ê°œìˆ˜
* ê²Œì‹œê¸€ ìƒì„¸ + ëŒ“ê¸€ ëª©ë¡
* ë§ˆì´í˜ì´ì§€: ë‚´ê°€ ì“´ ê¸€ ëª©ë¡ + ëŒ“ê¸€ ìš”ì•½ ì •ë³´

ì´ë²ˆ ê¸€ì—ì„œëŠ” **ê²Œì‹œíŒ(Post) â€“ ëŒ“ê¸€(Comment)** ë„ë©”ì¸ì„ ì˜ˆì‹œë¡œ,

> â€œN + 1ì´ ì •í™•íˆ ë¬´ì—‡ì´ê³ ,
> ì™œ í„°ì§€ê³ ,
> ì–´ë–»ê²Œ SQL ë ˆë²¨ê¹Œì§€ í˜ëŸ¬ê°€ë©°,
> ì‹¤ë¬´ì—ì„œ ì–´ë–¤ íŒ¨í„´ìœ¼ë¡œ í•´ê²°í•´ì•¼ í•˜ëŠ”ì§€â€

ë¥¼ ëê¹Œì§€ íŒŒí—¤ì³ ë³´ê² ìŠµë‹ˆë‹¤. ğŸ’£

---

## 1. ë„ë©”ì¸ ëª¨ë¸: Post â€“ Comment ê´€ê³„ ì •ì˜í•˜ê¸° ğŸ§±

ìš°ì„  ì „í˜•ì ì¸ ê²Œì‹œíŒ ë„ë©”ì¸ë¶€í„° ì¡ê³  ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.

### 1.1 ERD ê´€ì 

```text
Post (ê²Œì‹œê¸€)
---------
id (PK)
title
content
writer_id
created_at
...

Comment (ëŒ“ê¸€)
---------
id (PK)
post_id (FK) -> Post.id
content
writer_id
created_at
...
```

ê´€ê³„:

```text
Post 1 â”€â”€â”€â”€ N Comment
(ê²Œì‹œê¸€ 1ê°œ)   (ëŒ“ê¸€ ì—¬ëŸ¬ ê°œ)
```

### 1.2 JPA ì—”í‹°í‹° ë§¤í•‘ ì˜ˆì‹œ

```java
@Entity
public class Post {

    @Id @GeneratedValue
    private Long id;

    private String title;

    @Lob
    private String content;

    @OneToMany(mappedBy = "post", fetch = FetchType.LAZY)
    private List<Comment> comments = new ArrayList<>();

    // getter/setter ...
}

@Entity
public class Comment {

    @Id @GeneratedValue
    private Long id;

    private String content;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id")
    private Post post;

    // getter/setter ...
}
```

* **Post â†” Comment**

  * `Post` : `Comment` = **1 : N**
  * `Comment.post` â†’ `@ManyToOne`
  * `Post.comments` â†’ `@OneToMany(mappedBy = "post")`

ì—°ê´€ ê´€ê³„ ìì²´ëŠ” ì•„ë¬´ ë¬¸ì œ ì—†ìŠµë‹ˆë‹¤.
**ì§„ì§œ ë¬¸ì œëŠ” â€œì–´ë–»ê²Œ ì¡°íšŒí•˜ëŠëƒâ€ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤.**

---

## 2. ê²Œì‹œê¸€ ëª©ë¡ + ëŒ“ê¸€ ìˆ˜ ì¶œë ¥ ì½”ë“œì—ì„œ N + 1 í„°ì§€ëŠ” ê³¼ì • ğŸ’¥

### 2.1 ì„œë¹„ìŠ¤ ì½”ë“œ: ë§¤ìš° ìì£¼ ë³´ëŠ” íŒ¨í„´

```java
List<Post> posts = em.createQuery(
        "SELECT p FROM Post p ORDER BY p.id DESC",
        Post.class
).setMaxResults(10)
 .getResultList(); // ìµœì‹  10ê°œ ê²Œì‹œê¸€

for (Post post : posts) {
    System.out.println(
        "[ " + post.getTitle() + " ] ëŒ“ê¸€ ìˆ˜ = " + post.getComments().size()
    );
}
```

ë”± ë´ë„ â€œì•„ë¬´ ë¬¸ì œ ì—†ì–´ ë³´ì´ëŠ” ì½”ë“œâ€ì…ë‹ˆë‹¤.
í•˜ì§€ë§Œ ì—¬ê¸°ì„œ **ëŒ€í‘œì ì¸ N + 1 íŒ¨í„´**ì´ ë°œìƒí•©ë‹ˆë‹¤.

### 2.2 ì‹¤ì œ SQL íë¦„ ë”°ë¼ê°€ê¸°

#### â‘  ì²« ë²ˆì§¸ ì¿¼ë¦¬ (ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ, 1ë²ˆ)

```sql
SELECT
    p.id,
    p.title,
    p.content,
    ...
FROM post p
ORDER BY p.id DESC
LIMIT 10;
```

ì—¬ê¸°ê¹Œì§€ëŠ” ê´œì°®ìŠµë‹ˆë‹¤.
ë¬¸ì œëŠ” ê·¸ ë‹¤ìŒì…ë‹ˆë‹¤.

#### â‘¡ ë£¨í”„ ì•ˆì—ì„œì˜ `post.getComments()` ì ‘ê·¼

`comments`ëŠ” `LAZY`ì´ê¸° ë•Œë¬¸ì— ì‹¤ì œë¡œ í•„ìš”í•œ ìˆœê°„ì— ì¿¼ë¦¬ê°€ ë‚˜ê°‘ë‹ˆë‹¤.

```java
post.getComments().size();
```

ì´ í•œ ì¤„ì´ ê° ê²Œì‹œê¸€ë§ˆë‹¤ ë‹¤ìŒ SQLì„ ë°œìƒì‹œí‚µë‹ˆë‹¤.

```sql
SELECT
    c.id,
    c.post_id,
    c.content,
    ...
FROM comment c
WHERE c.post_id = ?;    -- ê° post.idë¡œ ë°”ë€Œë©´ì„œ Në²ˆ
```

ê²Œì‹œê¸€ì´ 10ê°œë¼ë©´:

* `SELECT ... FROM post` â†’ 1ë²ˆ
* `SELECT ... FROM comment WHERE post_id = ?` â†’ 10ë²ˆ

ì¦‰, **ì´ 11ë²ˆ ì¿¼ë¦¬ (N + 1)**

ê²Œì‹œê¸€ì´ 1,000ê°œë¼ë©´?

* **1 + 1,000 = 1,001ë²ˆ ì¿¼ë¦¬** ğŸ¤¯

ì´ê²Œ ë°”ë¡œ N + 1 ë¬¸ì œì…ë‹ˆë‹¤.

---

## 3. ì™œ ì´ëŸ° íŒ¨í„´ì´ ìƒê¸°ëŠ”ê°€? (ORM + LAZY ë¡œë”©ì˜ êµ¬ì¡°ì  ì´ìœ ) ğŸ§ 

### 3.1 ê¸°ë³¸ ì „ì œ: LAZY ë¡œë”©ì€ â€œí•„ìš”í•  ë•Œ ë¡œë”©â€ ì „ëµ

`@OneToMany(fetch = FetchType.LAZY)` ì´ë©´ JPAëŠ”

* ì²˜ìŒì—ëŠ” `comments` í•„ë“œë¥¼ **í”„ë¡ì‹œ ì»¬ë ‰ì…˜(ì˜ˆ: PersistentBag)**ìœ¼ë¡œë§Œ ì±„ìš°ê³ ,
* ì‹¤ì œë¡œ `.size()`, `.get(0)`, `for`ë¡œ ëŒë¦´ ë•Œ
  ê·¸ì œì„œì•¼ DBì—ì„œ ëŒ“ê¸€ì„ SELECT í•©ë‹ˆë‹¤.

ì´ ìì²´ëŠ” ì¢‹ì€ ì „ëµì…ë‹ˆë‹¤.
**ë¬¸ì œëŠ” â€œë£¨í”„ ì•ˆì—ì„œ ì´ê±¸ ë°˜ë³µí•´ì„œ ê±´ë“œë¦´ ë•Œâ€ì…ë‹ˆë‹¤.**

### 3.2 ë£¨í”„ + LAZY = N + 1

```java
for (Post post : posts) {
    post.getComments().size(); // ì§€ì—° ë¡œë”© í¬ì¸íŠ¸
}
```

* ë£¨í”„ ì²˜ìŒ í„´ì—ì„œ `post1.getComments()` â†’ ì¿¼ë¦¬ 1ë²ˆ
* ë‘ ë²ˆì§¸ í„´ì—ì„œ `post2.getComments()` â†’ ì¿¼ë¦¬ 1ë²ˆ
* ...
* Në²ˆì§¸ í„´ì—ì„œ `postN.getComments()` â†’ ì¿¼ë¦¬ 1ë²ˆ

â†’ **ê²°ê³¼ì ìœ¼ë¡œ Nê°œì˜ ëŒ“ê¸€ ì¡°íšŒ ì¿¼ë¦¬ê°€ ë”°ë¡œë”°ë¡œ ë‚˜ê°**

ORM ì…ì¥ì—ì„œëŠ” â€œì •ìƒì ì¸ ë™ì‘â€ì…ë‹ˆë‹¤.
í•˜ì§€ë§Œ **ì‹œìŠ¤í…œ ì…ì¥ì—ì„œëŠ” ë”ì°í•œ ë¹„íš¨ìœ¨**ì…ë‹ˆë‹¤.

---

## 4. ì‹¤ë¬´ì—ì„œ ì§„ì§œë¡œ í„°ì§€ëŠ” í™”ë©´ë“¤ ğŸ“º

ê²Œì‹œíŒì„ ê¸°ì¤€ìœ¼ë¡œ N + 1ì´ ì‹¤ì œë¡œ ì–´ë””ì„œ í„°ì§€ëŠ”ì§€ ì§šì–´ë³´ê² ìŠµë‹ˆë‹¤.

### 4.1 ê²Œì‹œê¸€ ëª©ë¡ í™”ë©´

* â€œê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ 20ê°œ + ê° ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ìˆ˜ í‘œì‹œâ€
* ì½”ë“œ:

```java
List<Post> posts = postRepository.findLatestPosts();
for (Post post : posts) {
    System.out.println(post.getComments().size());
}
```

â†’ **ê°€ì¥ í´ë˜ì‹í•œ N + 1**

### 4.2 ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€

```java
Post post = postRepository.findById(postId)
    .orElseThrow(...);

System.out.println(post.getTitle());

// ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
for (Comment comment : post.getComments()) {
    System.out.println(comment.getContent());
}
```

ê²Œì‹œê¸€ 1ê°œì— ëŒ“ê¸€ ìˆ˜ê°€ 10ê°œë¼ë©´
N+1 ë³´ë‹¤ëŠ” ì‘ì€ í¸ì´ì§€ë§Œ,

* í”„ë¡ì‹œ ì´ˆê¸°í™” ì¿¼ë¦¬ 1ë²ˆ
* í™”ë©´ì˜ ë‹¤ë¥¸ ë¡œì§ì—ì„œ ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ë˜ ì§€ì—° ë¡œë”©í•˜ë©´
  ë³µí•©ì ì¸ ì„±ëŠ¥ ì´ìŠˆë¡œ ë²ˆì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 4.3 ë§ˆì´í˜ì´ì§€: ë‚´ê°€ ì“´ ê¸€ + ëŒ“ê¸€ ìš”ì•½

* â€œë‚´ê°€ ì“´ ê²Œì‹œê¸€ 100ê°œ + ê° ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ ê°œìˆ˜ í‘œì‹œâ€
* í˜ì´ì§€ë„¤ì´ì…˜ì„ 20ê°œì”© í•˜ë”ë¼ë„,
  í•œ ìš”ì²­ë§ˆë‹¤ N + 1ì´ ë°˜ë³µë©ë‹ˆë‹¤.

---

## 5. SQL/ë¡œê·¸ì—ì„œ N + 1 íŒ¨í„´ í™•ì¸í•˜ê¸° ğŸ”

ì‹¤ì œë¡œ Hibernate ë¡œê·¸ë¥¼ ì¼œë‘ë©´ ì´ëŸ° íŒ¨í„´ì´ ë³´ì…ë‹ˆë‹¤.

```properties
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=TRACE
spring.jpa.properties.hibernate.format_sql=true
```

ì‹¤í–‰ í›„ ë¡œê·¸ (ì˜ì‚¬ ì½”ë“œ):

```sql
-- ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸
select p.id, p.title, ...
from post p
order by p.id desc
limit 10;

-- ëŒ“ê¸€ ì—¬ëŸ¬ ë²ˆ
select c.id, c.post_id, c.content, ...
from comment c
where c.post_id=?;

select c.id, c.post_id, c.content, ...
from comment c
where c.post_id=?;

select c.id, c.post_id, c.content, ...
from comment c
where c.post_id=?;

-- ë™ì¼ íŒ¨í„´ì˜ ì¿¼ë¦¬ê°€ ë°˜ë³µ...
```

> â€œê°™ì€ í˜•íƒœì˜ SELECTê°€ post_idë§Œ ë°”ë€Œë©´ì„œ ì­‰ ë°˜ë³µë˜ë©´â€
> â†’ N + 1ì¼ ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.

---

## 6. ì´ê²Œ ì™œ ê·¸ë ‡ê²Œ ìœ„í—˜í•œê°€? (ì„±ëŠ¥ ë¶„ì„ ê´€ì ) ğŸš¨

### 6.1 ì¿¼ë¦¬ ê°œìˆ˜ì˜ ì„ í˜• ì¦ê°€

* ê²Œì‹œê¸€ ê°œìˆ˜ = N
* ëŒ“ê¸€ ì¡°íšŒ ì¿¼ë¦¬ = Në²ˆ
* ì „ì²´ ì¿¼ë¦¬ = 1 + N

Nì´ 10 â†’ í‹°ê°€ ì•ˆ ë‚¨
Nì´ 1,000 â†’ DBê°€ ì‚´ì§ ë²„ë²…
Nì´ 10,000 â†’ DBê°€ ì£½ìŠµë‹ˆë‹¤ ğŸ”¥

### 6.2 ë„¤íŠ¸ì›Œí¬ Round Trip ë¹„ìš©

ê° SQLì€ ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.

1. ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ DBë¡œ SQL ì „ì†¡
2. DBì—ì„œ ì‹¤í–‰
3. ê²°ê³¼ë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ë°˜í™˜

N + 1ì€ ìœ„ ê³¼ì •ì„ **Në²ˆ ë°˜ë³µ**í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.

### 6.3 ì‹œìŠ¤í…œ ì „ì²´ ë¶€í•˜

* DB CPU/IO ì‚¬ìš©ëŸ‰ ì¦ê°€
* DB ì»¤ë„¥ì…˜ í’€ ì ìœ  ì‹œê°„ ì¦ê°€
* WAS â†’ DB ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ì¦ê°€
* ì „ì²´ API ì‘ë‹µ ì‹œê°„ ì¦ê°€
* íŠ¸ë˜í”½ í”¼í¬ ì‹œê°„ì— ì¥ì• ë¡œ ì´ì–´ì§

í•œ ë§ˆë””ë¡œ,

> â€œì¡°ê¸ˆë§Œ ì˜ëª» ì„¤ê³„í•˜ë©´, ê²Œì‹œíŒ ëª©ë¡ ì¡°íšŒ í•˜ë‚˜ê°€ DBë¥¼ í„°ëœ¨ë¦¬ëŠ” APIê°€ ë  ìˆ˜ ìˆë‹¤â€

ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.

---

## 7. í•´ê²° ì „ëµ â‘ : Fetch Joinìœ¼ë¡œ í•œ ë²ˆì— JOIN í•´ì„œ ê°€ì ¸ì˜¤ê¸° âš”

ê°€ì¥ ë¨¼ì € ë– ì˜¬ë¦´ ìˆ˜ ìˆëŠ” í•´ê²°ì±…ì€ **Fetch Join**ì…ë‹ˆë‹¤.

### 7.1 ì˜ˆì œ: ê²Œì‹œê¸€ + ëŒ“ê¸€ì„ í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°

```java
List<Post> posts = em.createQuery(
        "SELECT DISTINCT p FROM Post p " +
        "LEFT JOIN FETCH p.comments " +
        "ORDER BY p.id DESC",
        Post.class
).setMaxResults(10)  // âš  ì£¼ì˜
 .getResultList();
```

Hibernate SQL:

```sql
SELECT
    p.*,
    c.*
FROM post p
LEFT JOIN comment c ON c.post_id = p.id
ORDER BY p.id DESC
LIMIT 10;
```

ë˜ëŠ” DBì— ë”°ë¼ LIMITì´ ì˜¤íˆë ¤ ë°”ê¹¥ì— ê°ì‹¸ì§ˆ ìˆ˜ ìˆì§€ë§Œ ê°œë…ì€ ë™ì¼í•©ë‹ˆë‹¤.

### 7.2 ì¥ì 

* Post + Comment ì „ì²´ë¥¼ **í•œ ë²ˆì˜ SELECT**ë¡œ ê°€ì ¸ì˜´
* ë£¨í”„ ì•ˆì—ì„œ `post.getComments()`ë¥¼ í˜¸ì¶œí•´ë„ **ì¶”ê°€ ì¿¼ë¦¬ ì—†ìŒ**
* N + 1 ë¬¸ì œë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ í•´ê²°

### 7.3 ì£¼ì˜ì‚¬í•­ (ë§¤ìš° ì¤‘ìš”)

* `@OneToMany` Fetch Joinì€ **ì¤‘ë³µ Row**ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  * ê²Œì‹œê¸€ 1ê°œì— ëŒ“ê¸€ 3ê°œ â†’ ê²Œì‹œê¸€ row 3ê°œê°€ join ê²°ê³¼ì— ë‚˜íƒ€ë‚¨
  * JPAê°€ ë‚´ë¶€ì—ì„œ ì¤‘ë³µ ì œê±°ë¥¼ í•´ì£¼ê¸´ í•˜ì§€ë§Œ,
    **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ + í˜ì´ì§• ë¬¸ì œ**ê°€ ìƒê¹ë‹ˆë‹¤.

* ì»¬ë ‰ì…˜ Fetch Join + í˜ì´ì§•ì€ **Hibernate ê²½ê³ **:

  * DB ë ˆë²¨ í˜ì´ì§•ì´ ì•„ë‹ˆë¼, ë©”ëª¨ë¦¬ì—ì„œ ì˜ë¼ë‚¼ ìˆ˜ ìˆìŒ
  * ë°ì´í„° ì–‘ ë§ìœ¼ë©´ OutOfMemory ë¦¬ìŠ¤í¬

**ì‹¤ë¬´ íŒ:**

* â€œê²Œì‹œê¸€ ìƒì„¸ + ëŒ“ê¸€ ì „ì²´â€ â†’ Fetch Join OK
* â€œê²Œì‹œê¸€ ëª©ë¡ + ê°„ë‹¨ ìš”ì•½â€ â†’ ëŒ“ê¸€ì„ êµ³ì´ Fetch Join í•˜ì§€ ë§ê³  ë‹¤ë¥¸ ì „ëµ ì‚¬ìš©

---

## 8. í•´ê²° ì „ëµ â‘¡: Batch Fetching (`default_batch_fetch_size`) ğŸ“¦

Spring/Hibernate ì‹¤ë¬´ì—ì„œ **ê°€ì¥ ë§ì´ ì“°ì´ëŠ” í˜„ì‹¤ì ì¸ ì˜µì…˜**ì…ë‹ˆë‹¤.

### 8.1 ì„¤ì •

```properties
spring.jpa.properties.hibernate.default_batch_fetch_size=100
```

### 8.2 ë™ì‘ ë°©ì‹

1. `List<Post>` 10ê°œë¥¼ ì¡°íšŒ
2. ë£¨í”„ì—ì„œ ê°ê° `post.getComments()`ë¥¼ ì ‘ê·¼
3. Hibernateê°€ â€œì•„ ì´ Post ë“¤ì˜ idë¥¼ ë‹¤ ì•Œê³  ìˆë„¤?â€ ë¼ê³  íŒë‹¨í•˜ê³ 
   â†’ í•˜ë‚˜ì”© ì¿¼ë¦¬ ì˜ì§€ ì•Šê³  **IN ì¿¼ë¦¬**ë¡œ ë¬¶ì–´ì„œ ë³´ëƒ„

```sql
SELECT
    c.*
FROM comment c
WHERE c.post_id IN (?, ?, ?, ..., ?);   -- ìµœëŒ€ 100ê°œê¹Œì§€
```

ê²Œì‹œê¸€ì´ 10ê°œì´ê³  `default_batch_fetch_size=100`ì´ë©´

* ê²Œì‹œê¸€ 10ê°œ ì¡°íšŒ â†’ 1ì¿¼ë¦¬
* ëŒ“ê¸€ Nê°œ ì¡°íšŒ â†’ 1ì¿¼ë¦¬ (IN 10ê°œ)

â†’ ì´ 2ì¿¼ë¦¬ (ì‚¬ì‹¤ìƒ N + 1 ë¬¸ì œ ì†Œë©¸ì— ê°€ê¹Œì›€)

### 8.3 ì¥ì 

* ì»¬ë ‰ì…˜/ì—°ê´€ ì—”í‹°í‹° ì§€ì—° ë¡œë”©ì„ **ë¬¶ìŒìœ¼ë¡œ ì²˜ë¦¬**
* Fetch Joinì²˜ëŸ¼ í˜ì´ì§• ë¬¸ì œë¥¼ ì•¼ê¸°í•˜ì§€ ì•ŠìŒ
* ì„¤ì • í•œ ë²ˆìœ¼ë¡œ ì—¬ëŸ¬ ì—°ê´€ê´€ê³„ì—ë„ ê³µí†µ ì ìš©

### 8.4 ì‹¤ë¬´ì ì¸ ì¡°í•©

* ManyToOne, OneToOne, OneToMany ëª¨ë‘ LAZY ìœ ì§€
* í•„ìš”í•œ í™”ë©´ì—ì„œë§Œ:

  * Fetch Join (ë‹¨ê±´ ìƒì„¸, ë¦¬ìŠ¤íŠ¸ + ManyToOne)
  * * Batch Fetch (ì»¬ë ‰ì…˜ ë° ëŒ€ëŸ‰ ê´€ê³„)

> ì‹¤ë¬´ ì•„í‚¤í…íŠ¸ ë ˆë²¨ì—ì„œëŠ” ê±°ì˜ â€œê¸°ë³¸ ì„¸íŒ…â€ì²˜ëŸ¼ ë„£ì–´ë‘ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.

---

## 9. í•´ê²° ì „ëµ â‘¢: DTO Projectionìœ¼ë¡œ ì¡°íšŒ ì„¤ê³„ ìì²´ë¥¼ ë°”ê¾¸ê¸° ğŸ¯

íŠ¹íˆ **ê²Œì‹œê¸€ ëª©ë¡** ê°™ì€ ì¡°íšŒ ì „ìš© í™”ë©´ì€
ì• ì´ˆì— â€œì—”í‹°í‹°ë¥¼ ì¡°íšŒ â†’ ì§€ì—° ë¡œë”©â€ íŒ¨í„´ ëŒ€ì‹ ,

> â€œí•„ìš”í•œ ë°ì´í„°ë§Œ DTOë¡œ ì§ì ‘ ì¡°íšŒâ€

í•˜ëŠ” ê²ƒì´ í›¨ì”¬ ì„±ëŠ¥/êµ¬ì¡°ì ìœ¼ë¡œ ì¢‹ìŠµë‹ˆë‹¤.

### 9.1 ê²Œì‹œê¸€ ëª©ë¡ + ëŒ“ê¸€ ìˆ˜

```java
public class PostSummaryDto {
    private Long postId;
    private String title;
    private long commentCount;

    public PostSummaryDto(Long postId, String title, long commentCount) {
        this.postId = postId;
        this.title = title;
        this.commentCount = commentCount;
    }
}
```

JPQL:

```java
List<PostSummaryDto> result = em.createQuery(
    "SELECT new com.example.PostSummaryDto(" +
    "   p.id, p.title, COUNT(c.id) " +
    ") " +
    "FROM Post p " +
    "LEFT JOIN p.comments c " +
    "GROUP BY p.id, p.title " +
    "ORDER BY p.id DESC",
    PostSummaryDto.class
).setMaxResults(10)
 .getResultList();
```

SQL (ê°œë…):

```sql
SELECT
    p.id,
    p.title,
    COUNT(c.id) as comment_count
FROM post p
LEFT JOIN comment c ON c.post_id = p.id
GROUP BY p.id, p.title
ORDER BY p.id DESC
LIMIT 10;
```

* ì¿¼ë¦¬ 1ë²ˆ
* ëŒ“ê¸€ ê°œìˆ˜ê¹Œì§€ í•œ ë²ˆì— ê³„ì‚°
* ì—”í‹°í‹° ì§€ì—° ë¡œë”© ì—†ìŒ â†’ **N + 1 êµ¬ì¡° ìì²´ê°€ ì—†ë‹¤**

### 9.2 ê²Œì‹œê¸€ ìƒì„¸ + ëŒ“ê¸€ ëª©ë¡ë„ DTOë¡œ

```java
public class PostDetailDto {
    private Long postId;
    private String title;
    private String content;
    private List<CommentDto> comments;
    // ...
}
```

ì´ ë¶€ë¶„ì€

* `Post`ë¥¼ Fetch Joinìœ¼ë¡œ ê°€ì ¸ì˜¤ê±°ë‚˜
* `Post` + `Comment`ë¥¼ ê°ê° DTOë¡œ ê°€ì ¸ì˜¨ í›„ ë§¤í•‘

ë“±, ìƒí™©ì— ë”°ë¼ ë‹¤ì–‘í•œ ì„¤ê³„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## 10. í•´ê²° ì „ëµ â‘£: â€œì¿¼ë¦¬ë¥¼ 1+1ë¡œ ë‚˜ëˆ„ëŠ”â€ ìˆ˜ë™ Anti N+1 íŒ¨í„´ ğŸ”¨

ê°€ë”ì€ ë‹¤ìŒê³¼ ê°™ì€ ì „ëµì´ ê°€ì¥ ê¹”ë”í•©ë‹ˆë‹¤.

1. **ì²« ë²ˆì§¸ ì¿¼ë¦¬**: ê²Œì‹œê¸€ ëª©ë¡ë§Œ ì¡°íšŒ
2. **ë‘ ë²ˆì§¸ ì¿¼ë¦¬**: `post_id IN (...)` í˜•íƒœë¡œ ëŒ“ê¸€ í•œ ë²ˆì— ì¡°íšŒ
3. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ `Map<Long, List<Comment>>`ë¡œ ë§¤í•‘

ì¦‰,

```sql
-- 1. ê²Œì‹œê¸€ ëª©ë¡
SELECT * FROM post WHERE ... LIMIT 10;

-- 2. ëŒ“ê¸€ ëª©ë¡
SELECT * FROM comment WHERE post_id IN (1,2,3,...,10);
```

ì´ë¥¼ JPAë¡œ êµ¬í˜„í•˜ë©´:

```java
List<Post> posts = postRepository.findLatestPosts();

List<Long> postIds = posts.stream()
    .map(Post::getId)
    .toList();

List<Comment> comments = commentRepository.findByPostIdIn(postIds);

// postId -> ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ë§¤í•‘
Map<Long, List<Comment>> commentMap =
    comments.stream().collect(groupingBy(c -> c.getPost().getId()));

for (Post post : posts) {
    List<Comment> postComments = commentMap.getOrDefault(post.getId(), List.of());
    // ...
}
```

* ì¿¼ë¦¬ëŠ” 2ë²ˆ
* ì„±ëŠ¥ í›Œë¥­
* â€œì¡°íšŒëŠ” DTO or ìˆ˜ë™ ë§¤í•‘, ì“°ê¸°ëŠ” ì—”í‹°í‹°â€ ì „ëµê³¼ ì˜ ì–´ìš¸ë¦¼

---

## 11. í”¼í•´ì•¼ í•  â€œê°€ì§œ í•´ê²°ì±…â€ë“¤ ğŸ™…â€â™‚ï¸

### 11.1 FetchType.EAGERë¡œ ë°”ê¾¸ê¸°

```java
@OneToMany(fetch = FetchType.EAGER)
private List<Comment> comments;
```

ê²‰ìœ¼ë¡œëŠ” N + 1ì´ ì¤„ì–´ë“  ê²ƒì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ:

* ì˜ˆìƒì¹˜ ëª»í•œ ì¿¼ë¦¬ í­ë°œ
* ë‹¤ë¥¸ í™”ë©´ì—ì„œ í•„ìš” ì—†ëŠ” ëŒ“ê¸€ê¹Œì§€ ê³„ì† ëŒê³  ì˜´
* ë³µì¡í•œ ì—°ê´€ë§ì—ì„œ ì„±ëŠ¥ ì˜ˆì¸¡ ë¶ˆê°€

**ì‹¤ë¬´ ì›ì¹™:**

> ëª¨ë“  ì—°ê´€ê´€ê³„ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ LAZY
> â†’ í•„ìš”í•œ ê²½ìš°ì—ë§Œ Fetch Join / Batch Fetch / DTOë¡œ ìµœì í™”

### 11.2 â€œìºì‹œ ì¼œë©´ ë˜ì§€ ì•Šì„ê¹Œ?â€

2ì°¨ ìºì‹œ, Redis ìºì‹œ ë“±ì€

* â€œê°™ì€ ì—”í‹°í‹°ë¥¼ ì—¬ëŸ¬ ë²ˆ ì¡°íšŒí•  ë•Œâ€ DB ë¶€í•˜ë¥¼ ì¤„ì—¬ì¤„ ìˆ˜ ìˆì§€ë§Œ,
* **ì¿¼ë¦¬ êµ¬ì¡° ìì²´(N + 1)ë¥¼ ë°”ê¾¸ì§€ ì•ŠìŠµë‹ˆë‹¤.**

ì¿¼ë¦¬ íŒ¨í„´ì´ ì˜ëª»ëœ ê²ƒì€
**ì¿¼ë¦¬ íŒ¨í„´ì„ ë°”ê¿”ì•¼** í•©ë‹ˆë‹¤.

---

## 12. ì‹¤ë¬´ì—ì„œ N + 1 ì‚¬ëƒ¥í•˜ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ ğŸ•µï¸â€â™€ï¸

1. **SQL ë¡œê·¸ë¥¼ ì¼ ë‹¤**

   * ê°™ì€ íŒ¨í„´ì˜ SELECTê°€ Në²ˆ ë°˜ë³µë˜ëŠ”ì§€ í™•ì¸

2. **â€œë£¨í”„ ì•ˆì—ì„œ ì—°ê´€ ì—”í‹°í‹°/ì»¬ë ‰ì…˜ì„ ê±´ë“œë¦¬ëŠ” ì½”ë“œâ€ë¥¼ ì°¾ëŠ”ë‹¤**

   * `for (Post p : posts) p.getComments()...` íŒ¨í„´ ê²€ìƒ‰

3. **ê¸°ë³¸ ì „ëµ**

   * ì—°ê´€ê´€ê³„ëŠ” ëª¨ë‘ LAZY
   * `default_batch_fetch_size` ì„¤ì •

4. **í™”ë©´ ìœ í˜•ì— ë”°ë¼ ì „ëµ ë¶„ë¦¬**

   * ëª©ë¡: DTO Projection + ê·¸ë£¹ í•¨ìˆ˜(COUNT), í•„ìš”í•œ ìµœì†Œ ì •ë³´ë§Œ
   * ìƒì„¸: Fetch Join, Batch Fetch, DTO í˜¼í•©
   * ë§ˆì´í˜ì´ì§€: 1 + 1 ì¿¼ë¦¬ íŒ¨í„´(ê²Œì‹œê¸€ + IN ëŒ“ê¸€)

5. **ë¶€í•˜ í…ŒìŠ¤íŠ¸**

   * ê²Œì‹œê¸€, ëŒ“ê¸€ ë”ë¯¸ ë°ì´í„° ìˆ˜ì²œ~ìˆ˜ë§Œ ê±´ ì…ë ¥
   * ëª©ë¡/ìƒì„¸ API í˜¸ì¶œ ì‹œ ì¿¼ë¦¬ ìˆ˜ì™€ ì‘ë‹µ ì‹œê°„ ê´€ì°°

---

## ğŸ ë§ˆë¬´ë¦¬: ê²Œì‹œíŒì€ JPA ì„±ëŠ¥ ì„¤ê³„ì˜ â€œì—°ìŠµì¥â€ì´ì â€œì‹¤ì „â€ì´ë‹¤

ê²Œì‹œíŒ ê¸€ê³¼ ëŒ“ê¸€ì€ **ë‹¨ìˆœí•œ ë„ë©”ì¸ì´ì§€ë§Œ**,

* 1:N ì—°ê´€ê´€ê³„
* ëª©ë¡ + ìƒì„¸ + í†µê³„
* í˜ì´ì§•
* ì¹´ìš´íŠ¸/ì •ë ¬

ë“± ORM ì„±ëŠ¥ ì´ìŠˆê°€ ë‹¤ í„°ì§€ëŠ” ê³µê°„ì…ë‹ˆë‹¤.

> **N + 1 ë¬¸ì œë¥¼ â€œê²Œì‹œíŒ ë„ë©”ì¸ ê¸°ì¤€â€ìœ¼ë¡œ ì™„ì „íˆ ì´í•´í•˜ê³ ,
> Fetch Join / Batch Fetch / DTO ì„¤ê³„ / 1+1 ì¿¼ë¦¬ íŒ¨í„´ì„ ì ì ˆíˆ ì¡°í•©í•  ìˆ˜ ìˆë‹¤ë©´,
> ì›¬ë§Œí•œ ì„œë¹„ìŠ¤ì˜ JPA ì„±ëŠ¥ ë¬¸ì œëŠ” ëŒ€ë¶€ë¶„ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ğŸ’ª

