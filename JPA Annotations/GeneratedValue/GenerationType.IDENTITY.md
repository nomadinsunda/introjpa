# 🔍 1. JPA의 @GeneratedValue(strategy = GenerationType.IDENTITY)

```java
@Entity
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
}
```

이 설정은 **ID 값을 DB에 위임하여 자동 생성**되도록 설정하는 것입니다.

* `IDENTITY` 전략은 **JPA 구현체(Hibernate 등)가 시퀀스를 직접 사용하지 않고**,
  **DB의 자동 증가(auto-increment 또는 identity column)** 기능을 그대로 사용하는 방식입니다.

---

# 🧩 2. SQL 표준 IDENTITY 컬럼과 매핑 전략

SQL:2003부터 IDENTITY 컬럼이 표준으로 채택되었습니다:

```sql
id BIGINT GENERATED ALWAYS AS IDENTITY
```

JPA `GenerationType.IDENTITY`는 이 **SQL 표준 IDENTITY 컬럼에 대응**됩니다.

## 📌 동작 매핑 요약표

| DBMS            | JPA 전략 IDENTITY 동작                                   | SQL 표현식 예                                    |
| --------------- | ---------------------------------------------------- | -------------------------------------------- |
| **MySQL**       | AUTO\_INCREMENT 컬럼 사용                                | `id INT AUTO_INCREMENT`                      |
| **PostgreSQL**  | `SERIAL`, `BIGSERIAL`, 또는 `GENERATED AS IDENTITY` 사용 | `id BIGINT GENERATED ALWAYS AS IDENTITY`     |
| **SQL Server**  | `IDENTITY(1,1)` 사용                                   | `id INT IDENTITY(1,1)`                       |
| **Oracle 12c+** | `GENERATED AS IDENTITY` 사용                           | `id NUMBER GENERATED BY DEFAULT AS IDENTITY` |
| **DB2**         | `GENERATED ALWAYS AS IDENTITY` 사용                    | 동일                                           |

즉, JPA의 `GenerationType.IDENTITY`는 **SQL 표준의 IDENTITY 기능과 1:1 매핑되도록 설계**되어 있으며,
ORM 구현체가 **DB Dialect**에 따라 적절한 DDL을 생성합니다.

---

# 🔧 3. Hibernate Dialect에 따른 매핑 전략

Hibernate는 DB에 따라 다음과 같은 방식으로 `IDENTITY` 전략을 처리합니다.

### ✅ MySQLDialect

```sql
CREATE TABLE users (
  id BIGINT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (id)
);
```

* Hibernate는 `AUTO_INCREMENT`가 있는 열로 DDL 생성
* ID를 얻기 위해 JDBC의 `getGeneratedKeys()` 또는 `SELECT LAST_INSERT_ID()` 사용

---

### ✅ PostgreSQLDialect (10 이상)

```sql
CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY,
  PRIMARY KEY (id)
);
```

또는 `SERIAL`도 여전히 지원됨:

```sql
id BIGSERIAL PRIMARY KEY
```

* Hibernate는 내부적으로 PostgreSQL 10 이상에서는 `GENERATED AS IDENTITY`를 선호
* PostgreSQL 9.x 이하에서는 `SERIAL` 사용

---

### ✅ Oracle12cDialect

```sql
id NUMBER GENERATED BY DEFAULT AS IDENTITY
```

* Oracle 12c부터 SQL 표준 IDENTITY 컬럼을 지원하므로 Hibernate도 이를 자동 생성

---

### ✅ SQLServerDialect

```sql
id INT IDENTITY(1,1)
```

* SQL Server는 오래전부터 IDENTITY 열을 지원함
* Hibernate는 INSERT 후 `SELECT SCOPE_IDENTITY()`로 ID 조회

---

# 🧪 4. Hibernate의 IDENTITY 전략 동작 방식

> **다른 전략 (SEQUENCE, TABLE)과 다른 점**
> `IDENTITY` 전략은 **Insert 전에는 PK 값을 모름**
> → `em.persist()` 호출 시 즉시 **INSERT 쿼리를 날림**

## 🔁 순서

```java
em.persist(user);
```

➡ 내부적으로 다음이 수행됨

1. INSERT SQL 즉시 실행
2. DB가 자동으로 ID 생성 (AUTO\_INCREMENT / IDENTITY)
3. JDBC의 `getGeneratedKeys()` 또는 DB 전용 함수로 ID 조회
4. 엔티티의 ID 필드에 설정

---

# ⚠️ 5. IDENTITY 전략의 단점

| 문제            | 설명                                            |
| ------------- | --------------------------------------------- |
| ❌ 성능 문제       | 배치 삽입 시 매 건마다 INSERT가 발생하므로 성능이 떨어짐           |
| ❌ 지연 삽입 불가    | persist() 시점에 바로 INSERT 필요 → 영속성 컨텍스트에 지연 못 함 |
| ❌ 이식성 약화      | DB마다 IDENTITY 구현 방식이 달라 Dialect 의존도가 높음       |
| ❌ ID 사전 할당 불가 | 시퀀스처럼 미리 ID를 확보할 수 없음                         |

---

# ✅ 6. IDENTITY 전략을 선택해야 할 경우

* MySQL, SQL Server 등 **AUTO\_INCREMENT 기반 DB를 사용할 때**
* 간단한 프로젝트에서 설정을 줄이고 싶을 때
* 배치 성능보다 **간결성과 직관성**이 중요할 때

하지만 고성능 대규모 시스템에서는 보통 다음을 선호합니다:

> 🔁 **SEQUENCE 전략 + `allocationSize`** → DB 접근 줄여 성능 향상

---

# 🔍 7. JPA + SQL 표준의 일치도 평가

| 항목                      | 설명                                              | 일치도 |
| ----------------------- | ----------------------------------------------- | --- |
| SQL 문법                  | JPA의 IDENTITY → SQL `GENERATED AS IDENTITY`와 대응 | ✅   |
| 자동 ID 생성                | DB에 완전히 위임                                      | ✅   |
| 다이얼렉트에 따라 구현 다름         | PostgreSQL vs MySQL 차이 존재                       | ⚠️  |
| Hibernate가 시퀀스를 사용하지 않음 | 시퀀스 캐싱 불가                                       | ⚠️  |
| ID 사전 확보 불가             | 비동기 로직 불리함                                      | ❌   |

---

# 📌 요약 정리

| 항목           | GenerationType.IDENTITY                       |
| ------------ | --------------------------------------------- |
| 의미           | DB가 ID 값을 자동 생성                               |
| SQL 표준 대응    | `GENERATED ALWAYS AS IDENTITY`                |
| 실제 생성 DDL    | DB마다 다름 (AUTO\_INCREMENT, SERIAL, IDENTITY 등) |
| Hibernate 처리 | INSERT 즉시 실행 → ID 조회                          |
| 장점           | 설정 간단, DB 자동 처리                               |
| 단점           | 배치 처리 성능 저하, 미리 ID 확보 불가                      |
| 권장 사용 시점     | 단일 삽입, 간단한 테이블, MySQL 환경                      |


